---
title: "Save spatial results as one file"
author: "Carmen"
date: "July 17, 2018"
output: html_document
---

```{r}
require(tidyverse)
require(rgeos)
require(rgdal)
```

# Pull up one county and check it
```{r}
setwd("~/drought_tree_carbon/drought_tree_carbon/results/Counties")
load("Results_Spatial_Orange.Rdata")
names(spdf)
spdf@data <- spdf@data %>% 
  select(pixel_key, x, y, D_BM_kg, BM_live_2012_kg, Percent_Mortality_Biomass)
```

# Rename to shorter names
```{r}
spdf@data <- spdf@data %>% 
  rename(PercDeadBM = Percent_Mortality_Biomass) %>% 
  rename(DeadBMkg = D_BM_kg) %>% 
  rename(LiveBMkg = BM_live_2012_kg)
```


# Replace NA dead biomass with 0
```{r}
spdf@data <- spdf@data %>% 
  mutate(PercDeadBM = ifelse(is.na(PercDeadBM), 0, PercDeadBM)) %>% 
  mutate(DeadBMkg = ifelse(is.na(DeadBMkg ), 0, DeadBMkg)) 
```

## Check
```{r}
ggplot(spdf@data)+
  geom_tile(aes(x = x, y = y, col = PercDeadBM))+
  scale_color_gradient(low="light gray", high="red")

ggplot(spdf@data)+
  geom_tile(aes(x = x, y = y, col = DeadBMkg))+
  scale_color_gradient(low="light gray", high="red")

ggplot(spdf@data)+
  geom_tile(aes(x = x, y = y, col = LiveBMkg))+
  scale_color_gradient(low="light gray", high="red")
```

## Save
```{r}
setwd("~/drought_tree_carbon/drought_tree_carbon/results/IGIS")
save(spdf, file = "Orange25.Rdata")
```


# Loop it across all counties
```{r}
setwd("~/drought_tree_carbon/drought_tree_carbon/")
load(file = "data/CA_counties.Rdata")
to <- "~/drought_tree_carbon/drought_tree_carbon/data/active_unit/"
counties@data$NAME
plot(counties)
for(i in 1:length(counties)){
  print(i)
  # Remove county from folder
  active_county <- list.dirs("~/drought_tree_carbon/drought_tree_carbon/data/active_unit/", recursive = F)
  unlink(active_county, recursive = T)
  
  # Save new county to folder active_unit
  county <- counties[i,]
  setwd("~/drought_tree_carbon/drought_tree_carbon/data/active_unit/")
  lay <- as.character(county@data$NAME)
  dir.create(lay)
  print(lay)
  writeOGR(obj = county, dsn = lay, layer = lay, driver = "ESRI Shapefile")
  setwd("~/drought_tree_carbon/drought_tree_carbon/results/Counties")
  result_file <- paste("Results_Spatial_", lay, ".Rdata", sep = "")
  load(result_file)
  spdf@data <- spdf@data %>% 
    select(pixel_key, x, y, D_BM_kg, BM_live_2012_kg, Percent_Mortality_Biomass)
  spdf@data <- spdf@data %>% 
    rename(PercDeadBM = Percent_Mortality_Biomass) %>% 
    rename(DeadBMkg = D_BM_kg) %>% 
    rename(LiveBMkg = BM_live_2012_kg)
  spdf@data <- spdf@data %>% 
    mutate(PercDeadBM = ifelse(is.na(PercDeadBM), 0, PercDeadBM)) %>% 
    mutate(DeadBMkg = ifelse(is.na(DeadBMkg ), 0, DeadBMkg)) 
  setwd("~/drought_tree_carbon/drought_tree_carbon/results/IGIS")
  final_file <- paste(lay, "25.Rdata", sep = "") 
  save(spdf, file = final_file)
}
```

